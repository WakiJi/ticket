<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, shrink-to-fit=no"/>
    <title>舞萌痴 Web 跑图券 - 二次元限定</title>

    <link rel="stylesheet" href="https://unpkg.com/mdui@2/mdui.css">
    <script src="https://unpkg.com/mdui@2/mdui.global.js"></script>

    <style>
        /* 背景样式 */
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box; /* 确保 padding 不会超出视口 */
            overflow: hidden; /* 防止背景图滚动 */

            /* 随机二次元背景图 */
            background-image: url('https://api.sretna.cn/api/anime.php'); /* Unsplash随机动漫风景图 */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed; /* 背景固定不随滚动条滚动 */
            
            /* 背景模糊效果 */
            filter: blur(5px); /* 给整个 body 元素添加模糊 */
            transform: scale(1.02); /* 略微放大以避免模糊边缘 */
        }

        /* 覆盖 body 的模糊，以便在上面显示清晰内容 */
        #app-container {
            position: fixed; /* 固定在视口中央 */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            z-index: 1; /* 确保在模糊背景之上 */
            filter: none; /* 移除容器自身的模糊 */
            transform: none; /* 移除容器自身的放大 */
        }

        /* 卡片容器样式 - 磨砂效果 */
        .container {
            width: 400px;
            max-width: 90%; /* 响应式设计 */
            padding: 25px; /* 增加内边距 */
            background-color: rgba(255, 255, 255, 0.1); /* 半透明白色背景 */
            border-radius: 16px; /* 圆角 */
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); /* 阴影 */
            border: 1px solid rgba(255, 255, 255, 0.18); /* 边框 */
            
            /* 磨砂效果关键属性 */
            backdrop-filter: blur(10px) saturate(180%);
            -webkit-backdrop-filter: blur(10px) saturate(180%); /* Safari 兼容 */
            
            color: #fff; /* 文字颜色 */
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5); /* 文字阴影 */
            box-sizing: border-box;
        }
        
        /* 标题样式 */
        h1 {
            text-align: center;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; /* 更改字体 */
            color: #fff;
            margin-bottom: 15px;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.7);
        }

        /* 副标题/提示文字 */
        p {
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9em;
            margin-bottom: 25px;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        /* 输入框和选择框颜色调整 */
        mdui-text-field, mdui-select {
            margin-bottom: 25px;
            --mdui-text-field-label-color: rgba(255, 255, 255, 0.7);
            --mdui-text-field-input-color: #fff;
            --mdui-text-field-focus-line-color: #92e3a9; /* 聚焦时的底部线颜色 */
            --mdui-text-field-hover-line-color: rgba(255, 255, 255, 0.5);
            --mdui-text-field-text-color: #fff; /* 输入文字的颜色 */
        }
        
        /* 按钮样式 */
        mdui-button {
            --mdui-button-text-color: #fff;
            --mdui-button-background-color: rgba(146, 227, 169, 0.7); /* 半透明绿色 */
            --mdui-button-hover-background-color: rgba(146, 227, 169, 0.9);
            --mdui-button-pressed-background-color: rgba(146, 227, 169, 1);
            font-weight: bold;
            letter-spacing: 1px;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        /* 下拉菜单项的颜色调整 */
        mdui-menu-item {
             color: #333; /* 默认菜单项文字颜色 */
        }
        mdui-menu-item:hover {
            background-color: rgba(146, 227, 169, 0.2);
        }
    </style>
</head>
<body>

<div id="app-container">
    <div class="container">
        <div>
            <h1>舞萌痴 Web 跑图券</h1>
            <p>Worker URL 已内置，输入 User ID 即可操作。</p>
            
            <mdui-text-field label="User ID" id="uid_input" type="number" required></mdui-text-field>

            <mdui-select label="跑图券倍数" id="ticket_select">
                <mdui-menu-item value="2">2 倍券</mdui-menu-item>
                <mdui-menu-item value="3">3 倍券</mdui-menu-item>
                <mdui-menu-item value="4">4 倍券</mdui-menu-item>
                <mdui-menu-item value="5">5 倍券</mdui-menu-item>
                <mdui-menu-item value="6">6 倍券</mdui-menu-item>
            </mdui-select>

            <mdui-button fullwidth id="ticket_btn" variant="tonal">发放跑图券</mdui-button>
        </div>
    </div>
</div>

<script>
    // ** 【重要】请替换为您的 Cloudflare Worker 实际地址！ **
    const WORKER_PROXY_URL = "https://ticket.2206602594.workers.dev/index";
    // 示例: const WORKER_PROXY_URL = "https://my-maimai-worker.workers.dev/ticket";

    // --- 核心业务逻辑：通过 Worker API 发送请求 ---
    async function sendTicket(uid, ticketId) {
        if (!WORKER_PROXY_URL.startsWith('http')) {
            throw new Error("Worker URL 未配置或格式错误，请检查 index.html 文件。");
        }
        
        // 前端只发送 User ID 和要发放的倍券 ID
        const response = await fetch(WORKER_PROXY_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ uid: uid, ticket_id: ticketId })
        });

        if (!response.ok) {
             throw new Error("网络请求失败，请检查 Worker URL 和状态码: " + response.status);
        }

        const jsonResponse = await response.json();
        return jsonResponse;
    }

    // --- 事件监听和记忆功能 ---
    document.addEventListener('DOMContentLoaded', () => {
        const uidInput = document.getElementById('uid_input');
        const ticketSelect = document.getElementById('ticket_select');
        const ticketBtn = document.getElementById('ticket_btn');

        // 加载记忆值
        const lastUid = localStorage.getItem("last_uid");
        if (lastUid) {
            uidInput.value = lastUid;
        }
        const lastTicket = localStorage.getItem("last_ticket");
        if (lastTicket) {
            ticketSelect.value = lastTicket;
        } else {
            // 如果没有记忆，默认选中2倍券
            ticketSelect.value = "2";
        }

        // 当输入框或选择框值改变时，保存到本地
        uidInput.addEventListener("blur", () => { localStorage.setItem("last_uid", uidInput.value); });
        ticketSelect.addEventListener("change", () => { localStorage.setItem("last_ticket", ticketSelect.value); });

        ticketBtn.addEventListener("click", async () => {
            const uid = parseInt(uidInput.value);
            const ticketId = parseInt(ticketSelect.value); // 从下拉菜单获取值

            if (isNaN(uid) || uid <= 0) {
                return mdui.snackbar({ message: "请输入有效的 User ID" });
            }
            if (isNaN(ticketId) || ticketId < 2 || ticketId > 6) {
                return mdui.snackbar({ message: "请选择跑图券倍数" });
            }
            
            mdui.confirm({
                headline: "确认发放",
                description: `确认向用户 <strong>${uid}</strong> 发放 <strong>${ticketId} 倍</strong> 跑图券吗？`,
                confirmText: "确认发放",
                cancelText: "取消",
                onConfirm: async () => {
                    
                    // 常驻 Snackbar 提示
                    const loadingSnack = mdui.snackbar({ message: "正在执行，请等待 Worker 完成...", closeOnOutsideClick: false, timeout: 0 });

                    try {
                        const result = await sendTicket(uid, ticketId);
                        
                        if (result.is_success) {
                            mdui.alert({
                                headline: "操作成功",
                                description: result.message,
                                confirmText: "好"
                            });
                        } else {
                            mdui.alert({
                                headline: "操作失败",
                                description: `${result.message} <br><br> 错误详情: ${JSON.stringify(result.data || result.error || {})}`,
                                confirmText: "好"
                            });
                        }
                    } catch (e) {
                         mdui.alert({
                            headline: "网络或 Worker 错误",
                            description: `请检查您的 Worker 配置和部署状态。<br><br> 错误信息: ${e.message}`,
                            confirmText: "好"
                        });
                    } finally {
                        // 移除常驻 Snackbar
                        document.querySelector('mdui-snackbar[open]').remove();
                    }
                }
            });
        });
    });
</script>

</body>
</html>